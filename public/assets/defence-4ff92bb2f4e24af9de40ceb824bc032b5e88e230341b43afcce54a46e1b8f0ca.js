var attackers,defenders,obstacles,attackStrength=8,attackerCount=attackStrength,defenceStrength=Math.round(defence/4),defenderCount=Math.round(defence/4),defenceAudio,newCitizens,tutorialDefence="first",tutorialSprite,tutorialSpeechBubble,tutorialText="",tutorialText2="",tutorialText3="",tutorialText4="",tutorialText5="",tutorialText6="",defenceState={create:function(){game.world.removeAll(),game.physics.startSystem(Phaser.Physics.ARCADE),game.add.sprite(0,0,"cityOutskirts"),defenceAudio=game.add.audio("defence"),defenceAudio.stop(),defenceAudio.loopFull(.5),coins>=1e6?coinsText=game.add.bitmapText(395,10,"font",Math.round(coins/1e3)/1e3+"M",30):coinsText=game.add.bitmapText(395,10,"font",coins,30),hudDisplay=game.add.sprite(0,0,"hudDisplay"),hudDisplay.scale.setTo(1.1,1.1),hpBar=game.add.sprite(92,7,"hudBarRed"),hpBar.scale.setTo(1.1,1.1),hpCrop=new Phaser.Rectangle(0,0,88,15),hpBar.crop(hpCrop),healthText=game.add.bitmapText(93,7,"fontWhite","HP: "+health+"/"+maxHealth,15),manaBar=game.add.sprite(92,28,"hudBarBlue"),manaBar.scale.setTo(1.1,1.1),manaCrop=new Phaser.Rectangle(0,0,88,15),manaBar.crop(manaCrop),manaText=game.add.bitmapText(93,28,"fontWhite","MP: "+mana+"/"+maxMana,15),xpBar=game.add.sprite(92,50,"hudBarGreen"),xpBar.scale.setTo(1.1,1.1),xpCrop=new Phaser.Rectangle(0,0,88,15),xpBar.crop(xpCrop),xpText=game.add.bitmapText(93,50,"fontWhite","XP: "+xpDisplay+"/"+nextLevelXpDisplay,15),this.xpDisplayConvert(),playerLevel>=100?playerLevelText=game.add.bitmapText(9,23,"font",playerLevel,30):playerLevel>=10?playerLevelText=game.add.bitmapText(18,23,"font",playerLevel,30):playerLevelText=game.add.bitmapText(26,23,"font",playerLevel,30),coinsText.alpha=.7,xpText.alpha=.7,healthText.alpha=.7,manaText.alpha=.7,playerLevelText.alpha=.7,coinDisplay=game.add.sprite(360,8,"coin"),coinDisplay.frame=0,player=game.add.sprite(16,120,"dude"),game.physics.arcade.enable(player),player.body.setSize(28,32,2,2),player.body.collideWorldBounds=!0,player.isAlive=!0,player.animations.add("left",[9,10,11],10,!0),player.animations.add("right",[3,4,5],10,!0),player.animations.add("up",[0,1,2],10,!0),player.animations.add("down",[6,7,8],10,!0),player.animations.add("stop",[4],10,!0),player.animations.play("stop"),bullets=game.add.group(),bullets.enableBody=!0,bullets.createMultiple(90,"bullet"),attackers=game.add.group(),attackers.enableBody=!0,defenders=game.add.group(),defenders.enableBody=!0,obstacles=game.add.group(),obstacles.enableBody=!0;for(var e=1;e<=attackStrength;e++)this.attackerCreate(680,32*e);if(coins>=0)for(var e=0;e<=defenceStrength;e++)e<=12?this.defenderCreate(224,32*e):this.defenderCreate(188,32*(e-12));for(var e=0;e<=17;e++)if(e<=8){var t=obstacles.create(64*e,160,"statue");t.body.setSize(30,18,1,45),t.body.immovable=!0,t.frame=0}else{var t=obstacles.create(64*(e-9),384,"statue");t.body.setSize(30,18,1,45),t.body.immovable=!0,t.frame=0}cursors=game.input.keyboard.createCursorKeys(),spaceBar=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),wKey=game.input.keyboard.addKey(Phaser.Keyboard.W),aKey=game.input.keyboard.addKey(Phaser.Keyboard.A),sKey=game.input.keyboard.addKey(Phaser.Keyboard.S),dKey=game.input.keyboard.addKey(Phaser.Keyboard.D),resultBackground=game.add.sprite(-1e3,150,"scrollStrip"),resultText=game.add.bitmapText(140,185,"font","",32),tutorialSpeechBubble=game.add.button(-200,469,"speechBubble",this.tutorialChange,this),this.tutorialText(),this.tutorialShow()},update:function(){""==tutorialDefence?(game.physics.arcade.collide(defenders,attackers,this.npcFight,null,this),game.physics.arcade.collide(attackers,attackers),game.physics.arcade.collide(defenders,defenders),game.physics.arcade.collide(player,obstacles),game.physics.arcade.collide(attackers,obstacles,this.attackerMove,null,this),game.physics.arcade.collide(defenders,obstacles),game.time.now>invulnerableTimer?(player.alpha=1,game.physics.arcade.collide(player,attackers,this.badTouchDefence,null,this)):player.alpha=.5,game.physics.arcade.collide(bullets,attackers,this.attackerKill,null,this),attackerCount<=0&&game.physics.arcade.collide(player,door,this.defenceDoorOpen,null,this),player.body.velocity.x=0,player.body.velocity.y=0,aKey.isDown?(player.body.velocity.x=-runSpeed,player.animations.play("left"),facing="left",manaRegenInterval=manaRegenHolder):dKey.isDown?(player.body.velocity.x=runSpeed,player.animations.play("right"),facing="right",manaRegenInterval=manaRegenHolder):wKey.isDown?(player.body.velocity.y=-runSpeed,player.animations.play("up"),facing="up",manaRegenInterval=manaRegenHolder):sKey.isDown?(player.body.velocity.y=runSpeed,player.animations.play("down"),facing="down",manaRegenInterval=manaRegenHolder):(player.animations.stop(),manaRegenInterval=.4*manaRegenHolder),(cursors.right.isDown||cursors.left.isDown||cursors.up.isDown||cursors.down.isDown)&&game.time.now>bulletTimer&&player.isAlive&&mana>=5&&(this.fire(),mana-=5,manaText.text="MP: "+mana+"/"+maxMana),this.manaRegen(),this.defenderUpdate(),this.attackerUpdate()):(player.body.velocity.x=0,player.body.velocity.y=0),spaceBar.isDown&&""!=tutorialDefence&&game.time.now>assistantChangeTimer&&(this.tutorialChange(),assistantChangeTimer=game.time.now+1e3),hpCrop.x=80*(1-health/maxHealth),hpBar.updateCrop(),manaCrop.x=80*(1-mana/maxMana),manaBar.updateCrop(),xpCrop.x=80*(1-xp/nextLevelXp),xpBar.updateCrop()},tutorialText:function(){tutorialSpeechBubble.x=-200,tutorialText=game.add.bitmapText(200,477,"fontBorder","",15),tutorialText2=game.add.bitmapText(170,494,"fontBorder","",15),tutorialText3=game.add.bitmapText(158,509,"fontBorder","",15),tutorialText4=game.add.bitmapText(158,524,"fontBorder","",15),tutorialText5=game.add.bitmapText(170,539,"fontBorder","",15),tutorialText6=game.add.bitmapText(190,554,"fontBorder","",15),tutorialText.tint=0,tutorialText2.tint=0,tutorialText3.tint=0,tutorialText4.tint=0,tutorialText5.tint=0,tutorialText6.tint=0},tutorialTextDestroy:function(){tutorialText.destroy(),tutorialText2.destroy(),tutorialText3.destroy(),tutorialText4.destroy(),tutorialText5.destroy(),tutorialText6.destroy()},defenderCreate:function(e,t){if(Math.random()<.5){var a=defenders.create(e,t,"warriorMan");a.gender="male"}else{var a=defenders.create(e,t,"warriorWoman");a.gender="female"}a.health=defenceStrength-2,a.maxHealth=defenceStrength-2,a.fighting=!1,a.timer=game.time.now,game.physics.arcade.enable(a),a.body.collideWorldBounds=!0,a.healthBarBack=a.addChild(game.add.graphics(0,0)),a.healthBarBack.lineStyle(3,12203264,1),a.healthBarBack.moveTo(0,0),a.healthBarBack.lineTo(20,0),a.healthBar=a.addChild(game.add.graphics(0,0)),a.healthBar.lineStyle(3,16767232,1),a.healthBar.moveTo(0,0),a.healthBar.lineTo(20*(a.health/a.maxHealth),0),a.healthBarBack.visible=!1,a.healthBar.visible=!1,a.animations.add("defenderLeft",[9,10,11],15,!0),a.animations.add("defenderRight",[3,4,5],15,!0),a.animations.add("defenderStop",[4],15,!0),a.animations.play("defenderStop")},defenderUpdate:function(){defenders.forEach(function(e){e.body.velocity.x=0,e.body.velocity.y=0,e.healthBar.clear(),e.healthBar.lineStyle(3,16767232,1),e.healthBar.moveTo(0,0),e.healthBar.lineTo(20*(e.health/e.maxHealth),0),Math.abs(player.x-e.x)+Math.abs(player.y-e.y)>300&&0==e.fighting?(game.physics.arcade.moveToObject(e,player,115),player.x<e.x?e.animations.play("defenderLeft"):e.animations.play("defenderRight")):e.animations.play("defenderStop")})},attackerCreate:function(e,t){var a=attackers.create(e,t,"attacker");a.health=attackStrength-3,a.maxHealth=attackStrength-3,a.timer=game.time.now,a.fighting=!1,game.physics.arcade.enable(a),a.body.collideWorldBounds=!0,a.healthBarBack=a.addChild(game.add.graphics(0,0)),a.healthBarBack.lineStyle(3,12203264,1),a.healthBarBack.moveTo(0,0),a.healthBarBack.lineTo(20,0),a.healthBar=a.addChild(game.add.graphics(0,0)),a.healthBar.lineStyle(3,16767232,1),a.healthBar.moveTo(0,0),a.healthBar.lineTo(20*(a.health/a.maxHealth),0),a.healthBarBack.visible=!1,a.healthBar.visible=!1,a.animations.add("attackerLeft",[9,10,11],15,!0),a.animations.add("attackerRight",[3,4,5],15,!0),a.animations.add("attackerStop",[10],15,!0),a.animations.play("attackerStop")},attackerUpdate:function(){attackers.forEach(function(e){e.body.velocity.x=0,e.body.velocity.y=0,e.healthBar.clear(),e.healthBar.lineStyle(3,16767232,1),e.healthBar.moveTo(0,0),e.healthBar.lineTo(20*(e.health/e.maxHealth),0),0==e.fighting?game.physics.arcade.moveToObject(e,player,110):e.animations.play("attackerStop"),player.body.x<e.body.x?e.animations.play("attackerLeft"):e.animations.play("attackerRight")})},attackerMove:function(e){e.y<player.y?e.y+=2:e.y-=2},attackerKill:function(e,t){if(this.smallExplosion(e.x,e.y),Math.random()>.66&&("left"==e.travel?t.x-=knockback:"right"==e.travel?t.x+=knockback:"up"==e.travel?t.y-=knockback:"down"==e.travel&&(t.y+=knockback)),e.kill(),t.health<=shotPower){t.kill(),this.maleDeathSFX();var a=game.add.sprite(t.x,t.y,"deathSheet");a.frame=2,game.time.events.add(1*Phaser.Timer.SECOND,function(){a.kill()}),xp+=3,this.xpDisplayConvert(),attackerCount--,this.checkLevelUp(),this.checkDefenceComplete()}else t.health-=shotPower,t.healthBarBack.visible=!0,t.healthBar.visible=!0},smallExplosion:function(e,t){var a=game.add.sprite(e,t,"explosionMini");a.animations.add("explosion",[0,1,2,3],30,!1),a.animations.play("explosion"),this.shortExplodeSFX(),game.time.events.add(.2*Phaser.Timer.SECOND,function(){a.destroy()})},fire:function(){var e=bullets.getFirstExists(!1);e.reset(player.x+10,player.y+15),e.animations.add("spin",[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],13,!0);var t=game.add.emitter(game.world.centerX,game.world.centerY,20);t.makeParticles("bulletParticles",[0,1,2,3]),t.gravity.y=0,t.forEach(function(e){e.body.allowGravity=!1},this),t.start(!1,500,50),e.addChild(t),game.time.events.add(.5*Phaser.Timer.SECOND,function(){t.destroy()}),t.x=0,t.y=0,e.scale.x=.8,e.scale.y=.8,e.lifespan=832/shotSpeed*1e3,cursors.left.isDown?(game.physics.arcade.moveToXY(e,0,e.y,shotSpeed),e.animations.play("spin"),e.travel="left",t.minParticleSpeed.set(-shotSpeed,0),t.maxParticleSpeed.set(-shotSpeed,0),t.rotation=3.14,t.x=-14,t.y=-8):cursors.right.isDown?(game.physics.arcade.moveToXY(e,832,e.y,shotSpeed),e.animations.play("spin"),e.travel="right",t.minParticleSpeed.set(shotSpeed,0),t.maxParticleSpeed.set(shotSpeed,0),t.rotation=3.14,t.x=14,t.y=-8):cursors.up.isDown?(game.physics.arcade.moveToXY(e,e.x,0,shotSpeed),e.animations.play("spin"),e.travel="up",t.minParticleSpeed.set(0,-shotSpeed),t.maxParticleSpeed.set(0,-shotSpeed),t.rotation=3.14,t.x=-8,t.y=-14):cursors.down.isDown&&(game.physics.arcade.moveToXY(e,e.x,600,shotSpeed),e.animations.play("spin"),e.travel="down",t.minParticleSpeed.set(0,shotSpeed),t.maxParticleSpeed.set(0,shotSpeed),t.rotation=3.14,t.x=-8,t.y=14),this.pew(),bulletTimer=game.time.now+bulletSpacing},pew:function(){var e=game.add.audio("pew");e.play()},shortExplodeSFX:function(){var e=game.add.audio("shortExplode");e.play()},maleDeathSFX:function(){var e=game.add.audio("maleDeath");e.play()},femaleDeathSFX:function(){var e=game.add.audio("femaleDeath");e.play()},badTouchDefence:function(){if(health>attackStrength-7){health-=attackStrength-7;var e=game.add.audio("grunt");e.play(),healthText.text="HP: "+health+"/"+maxHealth,invulnerableTimer=game.time.now+invulnerableSpacing}else{player.kill(),this.maleDeathSFX();var t=game.add.sprite(player.x,player.y,"deathSheet");t.frame=0;var a=game.add.audio("teleport");game.time.events.add(1*Phaser.Timer.SECOND,function(){t.kill();var e=game.add.sprite(t.x+5,t.y+5,"playerTeleport");e.animations.add("teleport",[0,1,2,3],8,!1),e.animations.play("teleport"),a.play(),defenceAudio.stop(),game.time.events.add(.5*Phaser.Timer.SECOND,function(){e.kill()})}),player.isAlive=!1,population-=defenceStrength,tutorialDefence="defeat",this.tutorialShow(),healthText.text="HP: 0/"+maxHealth,resultBackground.x=96,resultText.text=" Your Majesty, it is time to come home!",endLevelButton=game.add.button(305,250,"blankButton",this.defenceComplete,this),game.add.bitmapText(355,280,"font","Return to my City",16)}},checkLevelUp:function(){for(;xp>=nextLevelXp;){levelUpImage=game.add.sprite(132,15,"levelUp"),levelUpImage.animations.add("flash",[0,1,2],6,!0),levelUpImage.animations.play("flash");var e=game.add.audio("levelUpSound");e.play(),game.time.events.add(1*Phaser.Timer.SECOND,function(){levelUpImage.kill()}),xp-=nextLevelXp,nextLevelXp+=Math.round(9+.7*playerLevel),maxHealth++,maxMana++,shotPower+=.03,health=maxHealth,mana=maxMana,playerLevel++,this.xpDisplayConvert(),manaText.text="MP: "+mana+"/"+maxMana,healthText.text="HP: "+health+"/"+maxHealth,playerLevelText.text=playerLevel}},checkDefenceComplete:function(){attackerCount<=0&&player.isAlive&&(player.x<75&&player.y<145?(doorway=game.add.sprite(750,70,"doorway"),door=game.add.sprite(750,70,"animateddoor")):(doorway=game.add.sprite(5,70,"doorway"),door=game.add.sprite(5,70,"animateddoor")),door.animations.add("openDoor",[0,1,2,3],4,!1),game.physics.arcade.enable(door),door.body.immovable=!0,defenderCount/defenceStrength>=.5?(newCitizens=attackStrength-(defenceStrength-defenderCount)+2,population+=newCitizens,attackStrength++,tutorialDefence="victory",this.tutorialShow()):defenderCount/defenceStrength>=.25?(newCitizens=Math.round(1+attackStrength/10),population+=newCitizens,tutorialDefence="victory",this.tutorialShow()):(population++,tutorialDefence="narrowVictory",this.tutorialShow()))},defenceComplete:function(){defending=!1,game.world.removeAll(),game.state.start("city")},defenceDoorOpen:function(){door.animations.play("openDoor");var e=game.add.audio("creakylightwoodendoor1");e.play(),player.kill(),defenceAudio.stop();var t=this;game.time.events.add(2*Phaser.Timer.SECOND,function(){t.defenceComplete()})},manaRegen:function(){game.time.now>manaRegenTimer&&mana<maxMana&&(mana++,manaRegenTimer=game.time.now+manaRegenInterval,manaText.text="MP: "+mana+"/"+maxMana)},npcFight:function(e,t){if(e.timer<game.time.now)if(e.sword=e.addChild(game.add.sprite(20,0,"sword")),e.sword.animations.add("swing",[0,1,2,2,1,0],6,!0),e.sword.animations.play("swing"),e.fighting=!0,game.time.events.add(1*Phaser.Timer.SECOND,function(){e.fighting=!1,e.sword.kill()}),e.health<=attackStrength-7){e.kill();var a=game.add.sprite(e.x,e.y,"deathSheet");"male"==e.gender?(a.frame=8,this.maleDeathSFX()):(a.frame=9,this.femaleDeathSFX()),game.time.events.add(1*Phaser.Timer.SECOND,function(){a.kill()}),defenderCount--}else e.health-=attackStrength-7,e.timer=game.time.now+1e3,e.healthBarBack.visible=!0,e.healthBar.visible=!0;if(t.timer<game.time.now)if(t.sword=t.addChild(game.add.sprite(-12,0,"sword")),t.sword.animations.add("swing",[3,4,5,5,4,3],6,!0),t.sword.animations.play("swing"),t.fighting=!0,game.time.events.add(1*Phaser.Timer.SECOND,function(){t.fighting=!1,t.sword.kill()}),t.health<=1){t.kill(),this.maleDeathSFX();var a=game.add.sprite(t.x,t.y,"deathSheet");a.frame=2,game.time.events.add(1*Phaser.Timer.SECOND,function(){a.kill()}),attackerCount--,this.checkDefenceComplete()}else t.health--,t.timer=game.time.now+1e3,t.healthBarBack.visible=!0,t.healthBar.visible=!0},tutorialShow:function(){switch(tutorialDefence){case"first":tutorialSprite=game.add.sprite(350,469,"assistant"),tutorialSpeechBubble.x=150,tutorialText.text=" Your Majesty!",tutorialText2.text="   Our defenders are ",tutorialText3.text="outnumbered, but with you",tutorialText4.text="     to rally them we may ",tutorialText5.text="         yet prevail. ",tutorialText6.text="";break;case"second":this.tutorialTextDestroy(),this.tutorialText(),tutorialSprite=game.add.sprite(350,469,"assistant"),tutorialSpeechBubble.x=150,tutorialText.text="  A convincing",tutorialText2.text="     victory may even",tutorialText3.text="    persuade the citizens",tutorialText4.text="       of our neighbours",tutorialText5.text="     to move here for",tutorialText6.text="  their protection.",assistant="tutorialEnd";break;case"victory":this.tutorialTextDestroy(),this.tutorialText(),tutorialSprite=game.add.sprite(350,469,"assistant"),tutorialSpeechBubble.x=150,tutorialText.text="  You fought",tutorialText2.text="  them off! As news of",tutorialText3.text="   your victory spread our",tutorialText4.text="      city attracted "+newCitizens+" new ",tutorialText5.text="   immigrants to bolster ",tutorialText6.text="      our ranks.";break;case"narrowVictory":this.tutorialTextDestroy(),this.tutorialText(),tutorialSprite=game.add.sprite(350,469,"assistant"),tutorialSpeechBubble.x=150,tutorialText.text="  A narrow",tutorialText2.text="   victory, but a victory",tutorialText3.text="  nonetheless. 1 new citizen",tutorialText4.text="  moved to our city when",tutorialText5.text="  word of your success",tutorialText6.text="      spread.";break;case"defeat":this.tutorialTextDestroy(),this.tutorialText(),tutorialSprite=game.add.sprite(350,469,"assistant"),tutorialSpeechBubble.x=150,tutorialText.text="  Oh no! Our",tutorialText2.text="  forces were routed.",tutorialText3.text="  Our reserves fought off",tutorialText4.text="  the attackers but the raid",tutorialText5.text="   killed "+defenceStrength+" of our",tutorialText6.text="   citizens.";break;case"":tutorialText.text="",tutorialText2.text="",tutorialText3.text="",tutorialText4.text="",tutorialText5.text="",tutorialText6.text="",null!=tutorialSprite&&tutorialSprite.kill(),tutorialSpeechBubble.x=-200}},tutorialChange:function(){switch(tutorialDefence){case"first":tutorialDefence="second",this.tutorialShow();break;case"second":tutorialDefence="",tutorialSprite.kill(),tutorialSpeechBubble.x=-200,this.tutorialShow();break;case"victory":tutorialDefence="",tutorialSprite.kill(),tutorialSpeechBubble.kill(),this.tutorialShow();break;case"narrowVictory":tutorialDefence="",tutorialSprite.kill(),tutorialSpeechBubble.kill(),this.tutorialShow();break;case"defeat":tutorialDefence="",tutorialSprite.kill(),tutorialSpeechBubble.kill(),this.tutorialShow()}},xpDisplayConvert:function(){xp>=1e3?xpDisplay=Math.round(xp/100)/10+"k":xpDisplay=Math.round(xp),nextLevelXp>=1e3?nextLevelXpDisplay=Math.round(nextLevelXp/100)/10+"k":nextLevelXpDisplay=Math.round(nextLevelXp),xpText.text="XP: "+xpDisplay+"/"+nextLevelXpDisplay}};